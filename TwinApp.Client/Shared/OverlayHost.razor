@using Microsoft.AspNetCore.Components.WebAssembly.Authentication

@using TwinApp.Client.Services
@inject AuthServices Auth
@inject ProjectService Projects
@inject IGraphicService Graphics

@if (!_isAuthChecked)
{
    <LoginPanel/>

}
else if (!_isLoggedIn)
{
    <LoginPanel/>
}
else if (!Projects.HasActiveProject)
{
    <ProjectSelectionPanel OnProjectSelected="HandleProjectSelection" Projects="Projects.Projects" />
}
else
{
    <ControlPanel />
    <LeftMenuPanel />
}

@code {
    private bool _isLoggedIn;
    private bool _isAuthChecked = false;

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to project changes
        Projects.OnProjectChanged += () => InvokeAsync(StateHasChanged);

        // Check authentication status
        _isLoggedIn = await Auth.IsLoggedInAsync();
        _isAuthChecked = true;

        if (_isLoggedIn)
        {
            await Projects.LoadProjectsAsync();
        }
    }

    private async Task HandleProjectSelection(string projectId)
    {
        Projects.OpenProject(projectId);
        await Graphics.LoadProjectAsync(projectId);
        StateHasChanged();
    }
}